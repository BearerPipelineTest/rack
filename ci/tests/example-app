#!/bin/bash
set -ex -o pipefail

# Running locally:
#
#   export CIRCLE_ARTIFACTS=/tmp/
#   export CIRCLE_BUILD_NUM=0
#   ./ci/tests/example-app <repo from convox-examples>

export EXAMPLE_NAME=$1

# inferred
export CIRCLE_BUILD_NUM=${CIRCLE_BUILD_NUM:-0}
export APP_NAME=${EXAMPLE_NAME}-${CIRCLE_BUILD_NUM}
export STACK_NAME=convox-${CIRCLE_BUILD_NUM}

git clone git@github.com:convox-examples/${EXAMPLE_NAME}.git
cd ${EXAMPLE_NAME}

convox apps create $APP_NAME --wait

convox logs --app $APP_NAME > $CIRCLE_ARTIFACTS/$APP_NAME.log &

convox deploy --app $APP_NAME --wait

convox apps info --app $APP_NAME

balancer=$(convox api get /apps/$APP_NAME/formation | jq -r '.[] | select(.name == "web" and .ports[] == 443) | .balancer')
curl -vi -m2 --retry 60 --retry-delay 20 -k https://$balancer

convox scale web --count 2 --memory 128 --app $APP_NAME --wait

convox ps --stats --app $APP_NAME

convox run --app $APP_NAME web 'bin/test || true' | tee $CIRCLE_ARTIFACTS/$APP_NAME-run.log
